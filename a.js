import { parseStringPromise } from "xml2js";

export const isNil = (data) => {
  // eslint-disable-next-line eqeqeq
  return data == undefined;
};

const dfsResult = (record, temp = []) => {
  if (Array.isArray(record)) {
    for (const item of record) {
      dfsResult(item, temp);
    }
  }
  if (typeof record === "object" && record !== null) {
    if (Object.keys(record).length === 0) {
      return temp;
    }
    if (!isNil(record.title) && !isNil(record.url) && !isNil(record.pub_time)) {
      temp.push({
        title: record.title[0],
        url: record.url[0],
        pub_time: record.pub_time[0],
      });
    }
    for (const key in record) {
      dfsResult(record[key], temp);
    }
  }
  return temp;
};

export const parseXML = async (text) => {
  const result = await parseStringPromise(text, { trim: true });
  return dfsResult(result);
};

const testData = `<msg> <appmsg appid="" sdkver="0">       <title><![CDATA[2023-10-29第一篇]]></title>    <des><![CDATA[First bloo改几个东西，大概多少字呢？First bloodFirst bloodFirst blo]]></des>       <action></action>       <type>5</type>  <showtype>1</showtype>     <soundtype>0</soundtype>     <content><![CDATA[]]></content> <contentattr>0</contentattr>    <url><![CDATA[http://mp.weixin.qq.com/s?__biz=Mzg4OTIwMjY5MQ==&mid=100000001&idx=1&sn=42b6479933a4fd45cbb1a771954cf4be&chksm=4fee306d7899b97b02e49c06a397b4184cffc590c87867befc781c3105f91456f94c192b5a88&scene=0&xtrack=1&previewkey=friaSwaphREmYgt8XVdNgJ1iJUUG%25252F7eLf7OA%25252FVEtaJE%25253D#rd]]></url>        <lowurl><![CDATA[]]></lowurl>   <appattach>             <totallen>0</totallen>          <attachid></attachid>           <fileext></fileext>             <cdnthumburl><![CDATA[]]></cdnthumburl>                 <cdnthumbaeskey><![CDATA[]]></cdnthumbaeskey>           <aeskey><![CDATA[]]></aeskey>   </appattach>    <extinfo></extinfo>     <sourceusername></sourceusername>       <sourcedisplayname><![CDATA[]]></sourcedisplayname>     <mmreader>              <category type="20" count="2">                  <name><![CDATA[唐吉的黑匣子]]></name>          <topnew>                                 <cover><![CDATA[https://mmbiz.qpic.cn/sz_mmbiz_jpg/6wRR0kfpb1MppKQj4Jg18CmB8zhIHOeibAlzG3vepmGqKvZgTtMe4ic5IDCNaPdfGmd6TjwxjUfsBFKnjib0icA59A/640?wxtype=jpeg&wxfrom=0]]></cover>      <width>0</width>                                 <height>0</height>                              <digest><![CDATA[First bloo改几个东西，大概多少字呢？First bloodFirst bloodFirst blo]]></digest>                        </topnew>                               <item>  <itemshowtype>0</itemshowtype>  <title><![CDATA[2023-10-29第一篇]]></title>     <url><![CDATA[http://mp.weixin.qq.com/s?__biz=Mzg4OTIwMjY5MQ==&tempkey=MTI0MV9GdjZCRHFmOHR2dWMwZ3pzbmI2eDlTeE1SVnZtQnYxeGl1MHpJc3JJemxpWDNCY2lSZHBNcjdOeHl3ajVKVU80cVhFX2lqWUREY2lMdW5zSkhuLTgwNkh0NjVNOEpQc0c4Z3lWOHczVlB5OHhrWmpkekhkX1hZTk95YVdJWklDa0dmamtjWXpWRU9UcWtTajJSN09BN1BmNWlVYXNZRTRLZDVCS21Rfn4%3D&chksm=4fee306d7899b97b02e49c06a397b4184cffc590c87867befc781c3105f91456f94c192b5a88&scene=0&xtrack=1&previewkey=friaSwaphREmYgt8XVdNgJ1iJUUG%252F7eLf7OA%252FVEtaJE%253D#rd]]></url>   <shorturl><![CDATA[]]></shorturl>       <longurl><![CDATA[]]></longurl>         <pub_time>1698627421</pub_time>         <cover><![CDATA[https://mmbiz.qpic.cn/sz_mmbiz_jpg/6wRR0kfpb1MppKQj4Jg18CmB8zhIHOeibAlzG3vepmGqKvZgTtMe4ic5IDCNaPdfGmd6TjwxjUfsBFKnjib0icA59A/640?wxtype=jpeg&wxfrom=0|0|0]]></cover>   <tweetid></tweetid>     <digest><![CDATA[First bloo改几个东西，大概多少字呢？First bloodFirst bloodFirst blo]]></digest>        <fileid>100000002</fileid>      <sources>       <source>        <name><![CDATA[唐吉的黑匣子]]></name>  </source>       </sources>      <styles></styles>       <native_url></native_url>    <del_flag>0</del_flag>     <contentattr>0</contentattr>     <play_length>0</play_length>   <play_url><![CDATA[]]></play_url>       <voice_id><![CDATA[]]></voice_id>       <tid><![CDATA[]]></tid>         <nonce_id><![CDATA[]]></nonce_id>       <voice_type>0</voice_type>      <player><![CDATA[]]></player>   <template_op_type>0</template_op_type>  <weapp_username><![CDATA[]]></weapp_username>   <weapp_path><![CDATA[]]></weapp_path>   <weapp_version>0</weapp_version>        <weapp_state>0</weapp_state>     <music_source>0</music_source>     <pic_num>0</pic_num>        <show_complaint_button>0</show_complaint_button>        <vid><![CDATA[]]></vid>         <recommendation><![CDATA[]]></recommendation>   <pic_urls></pic_urls>   <multi_picture_cover></multi_picture_cover>     <comment_topic_id>0</comment_topic_id>  <cover_235_1><![CDATA[https://mmbiz.qpic.cn/sz_mmbiz_jpg/6wRR0kfpb1MppKQj4Jg18CmB8zhIHOeibAlzG3vepmGqKvZgTtMe4ic5IDCNaPdfGmd6TjwxjUfsBFKnjib0icA59A/640?wxtype=jpeg&wxfrom=0|0|0]]></cover_235_1>       <cover_1_1><![CDATA[https://mmbiz.qpic.cn/sz_mmbiz_jpg/6wRR0kfpb1MppKQj4Jg18CmB8zhIHOeibycADMicrnnXfg7fWjUOSvfzInP3ibCEpUkXA4WleBlksYEehVUGU2Jhw/300?wxtype=jpeg&wxfrom=0|0|0]]></cover_1_1>     <cover_16_9><![CDATA[https://mmbiz.qpic.cn/sz_mmbiz_jpg/6wRR0kfpb1MppKQj4Jg18CmB8zhIHOeibAlzG3vepmGqKvZgTtMe4ic5IDCNaPdfGmd6TjwxjUfsBFKnjib0icA59A/640?wxtype=jpeg&wxfrom=0|0|0]]></cover_16_9>     <appmsg_like_type>2</appmsg_like_type>     <video_width>0</video_width>     <video_height>0</video_height>     <is_pay_subscribe>0</is_pay_subscribe>     <summary><![CDATA[First bloo改几个东西，大概多少字呢？First bloodFirst bloodFirst bloodFirst bloodFirst bloodFirst bloodFirst blood]]></summary>         <general_string><![CDATA[]]></general_string>     <finder_feed></finder_feed>     <finder_live></finder_live>   </item> <item>  <itemshowtype>0</itemshowtype>  <title><![CDATA[也挺好的]]></title>     <url><![CDATA[http://mp.weixin.qq.com/s?__biz=Mzg4OTIwMjY5MQ==&tempkey=MTI0MV9vZzFObmd1VXl2eUJpUWtQbmI2eDlTeE1SVnZtQnYxeGl1MHpJc3JJemxpWDNCY2lSZHBNcjdOeHl3ajBZTnI3LWRUWDhyQ3ZVMUtNZGFuTktGaUF4T1pzR1RnLXBNWVQyRmlnVlB2NDdwZDBpdVNRRTZRRmtuaHFQSWZVUENMSTdZY01tRERvU2JxQWEtQ3hOclN5YmFnZ2l4enBWbzQweDhKVUx3fn4%3D&chksm=4fee306d7899b97b1519578282c60f432178696b2da2d8388acc6a2cf72563523a176aae76eb&scene=0&xtrack=1&previewkey=friaSwaphREmYgt8XVdNgJ1iJUUG%252F7eLf7OA%252FVEtaJE%253D#rd]]></url>   <shorturl><![CDATA[]]></shorturl>       <longurl><![CDATA[]]></longurl>         <pub_time>1698627421</pub_time>         <cover><![CDATA[https://mmbiz.qpic.cn/sz_mmbiz_jpg/6wRR0kfpb1MppKQj4Jg18CmB8zhIHOeibKO6TZ3rOfpUichyfd2L8ULEQcghXgqPZFU61evdxFfnN4ibNvRzMqkGg/300?wxtype=jpeg&wxfrom=0|0|0]]></cover>    <tweetid></tweetid>     <digest><![CDATA[随便写写吧随便写写吧随便写写吧随便写写吧随便写写吧随便写写吧随便写写吧随便写写吧随便写写吧随便写写吧随便写写]]></digest>      <fileid>100000005</fileid>      <sources>       <source>        <name><![CDATA[唐吉的黑匣子]]></name>   </source>       </sources>      <styles></styles>       <native_url></native_url>    <del_flag>0</del_flag>     <contentattr>0</contentattr>     <play_length>0</play_length>   <play_url><![CDATA[]]></play_url>       <voice_id><![CDATA[]]></voice_id>       <tid><![CDATA[]]></tid>         <nonce_id><![CDATA[]]></nonce_id>       <voice_type>0</voice_type>      <player><![CDATA[]]></player>   <template_op_type>0</template_op_type>  <weapp_username><![CDATA[]]></weapp_username>   <weapp_path><![CDATA[]]></weapp_path>   <weapp_version>0</weapp_version>        <weapp_state>0</weapp_state>     <music_source>0</music_source>     <pic_num>0</pic_num>        <show_complaint_button>0</show_complaint_button>        <vid><![CDATA[]]></vid>         <recommendation><![CDATA[]]></recommendation>   <pic_urls></pic_urls>   <multi_picture_cover></multi_picture_cover>     <comment_topic_id>0</comment_topic_id>  <cover_235_1><![CDATA[https://mmbiz.qpic.cn/sz_mmbiz_jpg/6wRR0kfpb1MppKQj4Jg18CmB8zhIHOeibMricgqCguDdmSCK557QUTCdcaDuhdIqFF6Efa7WUgJ4aiaSZg1Pckuhg/300?wxtype=jpeg&wxfrom=0|0|0]]></cover_235_1>        <cover_1_1><![CDATA[https://mmbiz.qpic.cn/sz_mmbiz_jpg/6wRR0kfpb1MppKQj4Jg18CmB8zhIHOeibKO6TZ3rOfpUichyfd2L8ULEQcghXgqPZFU61evdxFfnN4ibNvRzMqkGg/300?wxtype=jpeg&wxfrom=0|0|0]]></cover_1_1>     <cover_16_9><![CDATA[https://mmbiz.qpic.cn/sz_mmbiz_jpg/6wRR0kfpb1MppKQj4Jg18CmB8zhIHOeibKO6TZ3rOfpUichyfd2L8ULEQcghXgqPZFU61evdxFfnN4ibNvRzMqkGg/300?wxtype=jpeg&wxfrom=0|0|0]]></cover_16_9>     <appmsg_like_type>2</appmsg_like_type>     <video_width>0</video_width>     <video_height>0</video_height>     <is_pay_subscribe>0</is_pay_subscribe>     <summary><![CDATA[随便写写吧随便写写吧随便写写吧随便写写吧随便写写吧随便写写吧随便写写吧随便写写吧随便写写吧随便写写吧随便写写吧风呼呼呼哈哈哈哈号 有什么爱好呢？]]></summary>    <general_string><![CDATA[]]></general_string>     <finder_feed></finder_feed>     <finder_live></finder_live>   </item>        </category>              <publisher>                     <username></username>                   <nickname><![CDATA[唐吉的黑匣子]]></nickname>           </publisher>            <template_header></template_header>            <template_detail></template_detail>          <forbid_forward>0</forbid_forward>         <notify_msg></notify_msg>        </mmreader>     <thumburl><![CDATA[https://mmbiz.qpic.cn/sz_mmbiz_jpg/6wRR0kfpb1MppKQj4Jg18CmB8zhIHOeibAlzG3vepmGqKvZgTtMe4ic5IDCNaPdfGmd6TjwxjUfsBFKnjib0icA59A/640?wxtype=jpeg&wxfrom=0]]></thumburl>                                          </appmsg><fromusername></fromusername><appinfo><version>0</version><appname><![CDATA[唐吉的黑匣子]]></appname><isforceupdate>1</isforceupdate></appinfo></msg>`;

console.log(await parseXML(testData));
